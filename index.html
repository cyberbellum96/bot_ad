<!DOCTYPE html>
<html>
<head>
    <title>Форма подання</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #0088cc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #006699;
        }
        .photo-preview {
            max-width: 100%;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .photo-preview img {
            max-width: 100px;
            height: auto;
            border-radius: 4px;
        }
        .photo-upload {
            margin: 10px 0;
        }
        #photoCount {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<form id="sellingForm" style="display: none;">
    <h2>Продаж товару</h2>
    <div class="form-group">
        <label for="itemName">Назва товару:</label>
        <input type="text" id="itemName" required>
    </div>
    <div class="form-group">
        <label for="sellingCategory">Категорія:</label>
        <select id="sellingCategory" required>
            <option value="">Оберіть категорію</option>
            <option value="electronics">Електроніка</option>
            <option value="furniture">Меблі</option>
            <option value="transport">Транспорт</option>
            <option value="other">Інше</option>
        </select>
    </div>
    <div class="form-group">
        <label for="price">Ціна:</label>
        <div class="price-input">
            <input type="number" id="price" required>
        </div>
    </div>
    <div class="form-group">
        <label for="condition">Стан:</label>
        <select id="condition" required>
            <option value="new">Новий</option>
            <option value="used">Вживаний</option>
        </select>
    </div>
    <div class="form-group">
        <label for="sellerDescription">Опис товару:</label>
        <textarea id="sellerDescription" rows="4" required></textarea>
    </div>
    <div class="form-group">
        <label for="photos">Фотографії (максимум 10):</label>
        <input type="file" id="photos" accept="image/*" multiple class="photo-upload">
        <div id="photoCount"></div>
        <div id="photoPreview" class="photo-preview"></div>
    </div>
    <div class="form-group">
        <label for="sellerContact">Контактні дані:</label>
        <input type="text" id="sellerContact" required>
    </div>
    <button type="submit">Розмістити оголошення</button>
</form>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // Функція для конвертації фото в base64
    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Обробка попереднього перегляду фото
    document.getElementById('photos')?.addEventListener('change', async function(e) {
        const preview = document.getElementById('photoPreview');
        const photoCount = document.getElementById('photoCount');
        preview.innerHTML = '';
        
        if (this.files.length > 10) {
            alert('Можна вибрати максимум 10 фотографій');
            this.value = '';
            return;
        }

        photoCount.textContent = `Вибрано фотографій: ${this.files.length}/10`;

        for (let file of this.files) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);
        }
    });

    // Оновлений обробник подання форми
    document.getElementById('sellingForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = {};
        
        // Збираємо всі поля форми
        this.querySelectorAll('input:not([type="file"]), textarea, select').forEach(element => {
            formData[element.id] = element.value;
        });
        
        // Обробка фотографій
        const photoInput = this.querySelector('#photos');
        if (photoInput?.files.length > 0) {
            formData.photos = [];
            for (let file of photoInput.files) {
                try {
                    const base64 = await getBase64(file);
                    formData.photos.push(base64);
                } catch (error) {
                    console.error('Помилка конвертації фото:', error);
                }
            }
        }
        
        // Додаємо тип форми
        formData.formType = 'selling';
        
        // Відправляємо дані в Telegram
        tg.sendData(JSON.stringify(formData));
        tg.close();
    });

    // Показуємо потрібну форму при завантаженні фі
    function showForm() {
        const formType = new URLSearchParams(window.location.search).get('type');
        const forms = {
            'selling': 'sellingForm'
        };
        
        if (forms[formType]) {
            document.getElementById(forms[formType]).style.display = 'block';
        }
    }

    showForm();
</script>
</body>
</html>